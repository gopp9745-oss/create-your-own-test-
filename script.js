// ==================== БАЗА ДАННЫХ ПРЕДМЕТОВ ====================
const subjectsByClass = {
    1: ['Математика', 'Русский язык', 'Окружающий мир'],
    2: ['Математика', 'Русский язык', 'Окружающий мир'],
    3: ['Математика', 'Русский язык', 'Окружающий мир'],
    4: ['Математика', 'Русский язык', 'Окружающий мир'],
    5: ['Математика', 'Русский язык', 'Литература', 'История', 'География', 'Биология'],
    6: ['Математика', 'Русский язык', 'Литература', 'История', 'География', 'Биология'],
    7: ['Алгебра', 'Геометрия', 'Русский язык', 'Литература', 'История', 'География', 'Биология', 'Физика'],
    8: ['Алгебра', 'Геометрия', 'Русский язык', 'Литература', 'История', 'География', 'Биология', 'Физика', 'Химия'],
    9: ['Алгебра', 'Геометрия', 'Русский язык', 'Литература', 'История', 'География', 'Биология', 'Физика', 'Химия'],
    10: ['Алгебра', 'Геометрия', 'Русский язык', 'Литература', 'История', 'География', 'Биология', 'Физика', 'Химия'],
    11: ['Алгебра', 'Геометрия', 'Русский язык', 'Литература', 'История', 'География', 'Биология', 'Физика', 'Химия']
};

// ==================== БАЗА ЗАДАНИЙ ПО УЧЕБНИКАМ ====================
const taskDatabase = {
    // ==================== МАТЕМАТИКА ====================
    'Математика': {
        // 4 класс
        '4класс': {
            'умножение': {
                test: [
                    { text: 'Вычислите: 123 × 4 =', answer: '492', options: ['492', '482', '502', '472'] },
                    { text: 'Вычислите: 205 × 3 =', answer: '615', options: ['615', '625', '605', '595'] },
                    { text: 'Вычислите: 312 × 2 =', answer: '624', options: ['624', '614', '634', '604'] },
                    { text: 'Вычислите: 450 × 2 =', answer: '900', options: ['900', '800', '1000', '850'] },
                    { text: 'Умножьте: 78 × 5 =', answer: '390', options: ['390', '380', '400', '370'] }
                ],
                independent: [
                    { text: 'Вычислите: 234 × 3 =', answer: '702' },
                    { text: 'Найдите произведение: 156 × 4 =', answer: '624' },
                    { text: 'Решите: 89 × 7 =', answer: '623' },
                    { text: 'Вычислите: 265 × 3 =', answer: '795' }
                ],
                control: [
                    { text: '1. Вычислите: 1234 × 5 =', answer: '6170' },
                    { text: '2. Вычислите: 456 × 7 =', answer: '3192' },
                    { text: '3. Решите задачу: 6 тетрадей по 25 рублей =', answer: '150 руб.' },
                    { text: '4. Вычислите: 234 × 8 - 500 =', answer: '1372' }
                ]
            },
            'деление': {
                test: [
                    { text: 'Вычислите: 96 : 8 =', answer: '12', options: ['12', '14', '10', '8'] },
                    { text: 'Вычислите: 84 : 7 =', answer: '12', options: ['12', '14', '10', '11'] },
                    { text: 'Вычислите: 156 : 3 =', answer: '52', options: ['52', '50', '54', '48'] },
                    { text: 'Найдите частное: 240 : 6 =', answer: '40', options: ['40', '45', '35', '50'] }
                ],
                independent: [
                    { text: 'Вычислите: 368 : 4 =', answer: '92' },
                    { text: 'Найдите частное: 525 : 5 =', answer: '105' },
                    { text: 'Разделите: 648 : 6 =', answer: '108' }
                ],
                control: [
                    { text: '1. Вычислите: 2835 : 5 =', answer: '567' },
                    { text: '2. Вычислите: 4328 : 8 =', answer: '541' },
                    { text: '3. Решите: 96 : x = 8', answer: 'x = 12' }
                ]
            },
            'дроби': {
                test: [
                    { text: 'Какая дробь больше: 3/7 или 5/7?', answer: '5/7', options: ['5/7', '3/7', 'равны', 'не знаю'] },
                    { text: 'Запишите: три восьмых', answer: '3/8', options: ['3/8', '8/3', '3/11', '8/11'] },
                    { text: 'Вычислите: 1/4 + 2/4 =', answer: '3/4', options: ['3/4', '3/8', '1/2', '1/4'] }
                ],
                independent: [
                    { text: 'Сравните: 2/5 и 3/5', answer: '2/5 < 3/5' },
                    { text: 'Запишите: пять девятых', answer: '5/9' },
                    { text: 'Вычислите: 1/3 + 1/3 =', answer: '2/3' }
                ],
                control: [
                    { text: '1. Вычислите: 2/5 + 3/5 =', answer: '1' },
                    { text: '2. Сравните: 3/8 и 5/8', answer: '3/8 < 5/8' },
                    { text: '3. Задача: Торт разрезали на 8 частей. Съели 3 части. Какая часть осталась?', answer: '5/8' }
                ]
            }
        },
        // 5 класс
        '5класс': {
            'натуральные числа': {
                test: [
                    { text: 'Запишите цифрами: три миллиона пятьсот тысяч', answer: '3 500 000', options: ['3 500 000', '3500000', '350000', '3005000'] },
                    { text: 'Округлите 4567 до тысяч', answer: '5000', options: ['5000', '4000', '4600', '4560'] },
                    { text: 'Сравните: 23001 и 23010', answer: '23001 < 23010', options: ['23001 < 23010', '23001 > 23010', 'равны', 'не знаю'] }
                ],
                independent: [
                    { text: 'Запишите: пятьдесят две тысячи триста один', answer: '52301' },
                    { text: 'Округлите 3456 до сотен', answer: '3500' }
                ],
                control: [
                    { text: '1. Вычислите: 45678 + 54322', answer: '100000' },
                    { text: '2. Округлите 98765 до тысяч', answer: '99000' }
                ]
            },
            'десятичные дроби': {
                test: [
                    { text: 'Запишите: 0,37 = ? %', answer: '37%', options: ['37%', '3,7%', '370%', '0,37%'] },
                    { text: 'Сравните: 0,5 и 0,49', answer: '0,5 > 0,49', options: ['0,5 > 0,49', '0,5 < 0,49', 'равны', 'не знаю'] },
                    { text: 'Вычислите: 2,5 + 1,3 =', answer: '3,8', options: ['3,8', '3,7', '3,9', '2,8'] }
                ],
                independent: [
                    { text: 'Вычислите: 5,6 - 2,3 =', answer: '3,3' },
                    { text: 'Умножьте: 2,5 × 4 =', answer: '10' }
                ],
                control: [
                    { text: '1. Вычислите: 12,5 × 8 =', answer: '100' },
                    { text: '2. Вычислите: 45,6 : 3 =', answer: '15,2' }
                ]
            },
            'обыкновенные дроби': {
                test: [
                    { text: 'Приведите к общему знаменателю: 1/2 и 1/3', answer: '3/6 и 2/6', options: ['3/6 и 2/6', '2/6 и 3/6', '1/6 и 2/6', '3/6 и 1/6'] },
                    { text: 'Вычислите: 1/2 + 1/4 =', answer: '3/4', options: ['3/4', '2/6', '1/2', '4/6'] },
                    { text: 'Умножьте: 2/3 × 3/5 =', answer: '2/5', options: ['2/5', '5/6', '6/15', '6/8'] }
                ],
                independent: [
                    { text: 'Вычислите: 3/5 - 1/5 =', answer: '2/5' },
                    { text: 'Умножьте: 2/7 × 7/9 =', answer: '2/9' }
                ],
                control: [
                    { text: '1. Вычислите: (1/2 + 1/3) × 6', answer: '5' },
                    { text: '2. Решите: x + 1/4 = 3/4', answer: 'x = 1/2' }
                ]
            }
        },
        // 6 класс
        '6класс': {
            '比例': {
                test: [
                    { text: 'Найдите отношение 8 к 2', answer: '4', options: ['4', '2', '6', '10'] },
                    { text: 'Составьте пропорцию: 2/6 = 3/9', answer: 'верно', options: ['верно', 'неверно', 'не знаю', 'зависит'] },
                    { text: 'x/5 = 3/15, найдите x', answer: 'x = 1', options: ['x = 1', 'x = 5', 'x = 3', 'x = 15'] }
                ],
                independent: [
                    { text: 'Найдите: 5 : 15', answer: '1/3' },
                    { text: 'Решите: x/7 = 2/14', answer: 'x = 1' }
                ],
                control: [
                    { text: '1. Найдите неизвестный член: 4/x = 8/20', answer: 'x = 10' },
                    { text: '2. Задача: 3 кг стоят 150 руб. Сколько стоят 7 кг?', answer: '350 руб.' }
                ]
            },
            'отрицательные числа': {
                test: [
                    { text: 'Вычислите: -5 + 3', answer: '-2', options: ['-2', '2', '-8', '8'] },
                    { text: 'Вычислите: -7 × (-2)', answer: '14', options: ['14', '-14', '-9', '9'] },
                    { text: 'Сравните: -5 и -3', answer: '-5 < -3', options: ['-5 < -3', '-5 > -3', 'равны', 'не знаю'] }
                ],
                independent: [
                    { text: 'Вычислите: -8 + 5', answer: '-3' },
                    { text: 'Вычислите: (-3) × 4', answer: '-12' }
                ],
                control: [
                    { text: '1. Вычислите: -15 + (-8)', answer: '-23' },
                    { text: '2. Вычислите: (-2) × (-7) × 3', answer: '42' }
                ]
            }
        },
        // Умножение и деление (общее)
        'умножение и деление': {
            test: [
                { text: 'Вычислите: 125 × 8 =', answer: '1000', options: ['1000', '800', '100', '10000'] },
                { text: 'Вычислите: 96 : 8 =', answer: '12', options: ['12', '14', '10', '8'] },
                { text: 'Вычислите: 24 × 13 =', answer: '312', options: ['312', '292', '332', '272'] },
                { text: 'Вычислите: 144 : 12 =', answer: '12', options: ['12', '14', '10', '11'] },
                { text: 'Вычислите: 56 × 7 =', answer: '392', options: ['392', '382', '402', '372'] },
                { text: 'Вычислите: 480 : 16 =', answer: '30', options: ['30', '28', '32', '26'] },
                { text: 'Вычислите: 15 × 15 =', answer: '225', options: ['225', '215', '235', '205'] },
                { text: 'Вычислите: 625 : 25 =', answer: '25', options: ['25', '23', '27', '21'] },
                { text: 'Вычислите: 17 × 9 =', answer: '153', options: ['153', '143', '163', '133'] },
                { text: 'Вычислите: 320 : 20 =', answer: '16', options: ['16', '14', '18', '12'] }
            ],
            independent: [
                { text: 'Решите задачу: 6 тетрадей стоят 72 рубля. Сколько стоит 1 тетрадь?', answer: '12 рублей' },
                { text: 'Вычислите: 123 × 4 =', answer: '492' },
                { text: 'Вычислите: 555 : 5 =', answer: '111' },
                { text: 'Решите задачу: 9 книг стоят 450 рублей. Сколько стоит 1 книга?', answer: '50 рублей' },
                { text: 'Вычислите: 25 × 8 × 4 =', answer: '800' },
                { text: 'Вычислите: 720 : 8 : 9 =', answer: '10' },
                { text: 'Решите задачу: 7 пачек печенья весят 350 г. Сколько весит 1 пачка?', answer: '50 г' },
                { text: 'Вычислите: 45 × 11 =', answer: '495' },
                { text: 'Вычислите: 1000 : 125 =', answer: '8' },
                { text: 'Решите задачу: 5 коробок карандашей стоят 200 рублей. Сколько стоит 1 коробка?', answer: '40 рублей' }
            ],
            control: [
                { text: '1. Вычислите: 247 × 38 =', answer: '9386' },
                { text: '2. Вычислите: 2856 : 8 =', answer: '357' },
                { text: '3. Решите задачу: Длина прямоугольника 18 см, ширина в 3 раза меньше. Найдите периметр.', answer: '48 см' },
                { text: '4. Вычислите: 25 × 4 × 7 × 5 =', answer: '3500' },
                { text: '5. Решите задачу: 8 кг яблок стоят 560 рублей. Сколько стоят 5 кг яблок?', answer: '350 рублей' }
            ]
        }
    },
    // ==================== АЛГЕБРА ====================
    'Алгебра': {
        '7класс': {
            'многочлены': {
                test: [
                    { text: 'Приведите подобные слагаемые: 3x + 5x - 2x', answer: '6x', options: ['6x', '10x', '8x', '6'] },
                    { text: 'Раскройте скобки: 3(x + 2)', answer: '3x + 6', options: ['3x + 6', '3x + 2', '3x - 6', 'x + 6'] },
                    { text: 'Умножьте: 2x × 3x', answer: '6x²', options: ['6x²', '6x', '5x²', '6'] },
                    { text: 'Раскройте: (x + 3)(x + 2)', answer: 'x² + 5x + 6', options: ['x² + 5x + 6', 'x² + 5x + 5', 'x² + 6x + 6', 'x² + x + 6'] },
                    { text: 'Приведите одночлен к стандартному виду: 2x² × 3x³', answer: '6x⁵', options: ['6x⁵', '6x⁶', '5x⁵', '6x'] }
                ],
                independent: [
                    { text: 'Упростите: 4x + 7 - 2x - 3', answer: '2x + 4' },
                    { text: 'Раскройте скобки: 5(2x - 3)', answer: '10x - 15' },
                    { text: 'Выполните умножение: x(x + 4)', answer: 'x² + 4x' }
                ],
                control: [
                    { text: '1. Раскройте скобки: (x + 2)(x - 3)', answer: 'x² - x - 6' },
                    { text: '2. Приведите подобные: 5x² + 3x - 2x² + 7', answer: '3x² + 3x + 7' },
                    { text: '3. Умножьте: 2x(x² - 3x + 1)', answer: '2x³ - 6x² + 2x' }
                ]
            },
            'формулы сокращённого умножения': {
                test: [
                    { text: 'Раскройте: (a + b)²', answer: 'a² + 2ab + b²', options: ['a² + 2ab + b²', 'a² + b²', 'a² + ab + b²', 'a² - 2ab + b²'] },
                    { text: 'Раскройте: (a - b)²', answer: 'a² - 2ab + b²', options: ['a² - 2ab + b²', 'a² + 2ab + b²', 'a² - b²', 'a² - ab + b²'] },
                    { text: 'Раскройте: (a - b)(a + b)', answer: 'a² - b²', options: ['a² - b²', 'a² + b²', 'a² - 2ab + b²', 'a² + 2ab + b²'] },
                    { text: 'Вычислите: 101² используя формулу', answer: '10201', options: ['10201', '10101', '10001', '11001'] }
                ],
                independent: [
                    { text: 'Раскройте: (x + 3)²', answer: 'x² + 6x + 9' },
                    { text: 'Разложите: x² - 9', answer: '(x - 3)(x + 3)' },
                    { text: 'Раскройте: (2x + 1)²', answer: '4x² + 4x + 1' }
                ],
                control: [
                    { text: '1. Разложите на множители: x² - 6x + 9', answer: '(x - 3)²' },
                    { text: '2. Вычислите: 99 × 101', answer: '9999' },
                    { text: '3. Раскройте: (x - 2)(x + 2) + 4', answer: 'x²' }
                ]
            },
            'линейные уравнения': {
                test: [
                    { text: 'Решите уравнение: x + 5 = 12', answer: 'x = 7', options: ['x = 7', 'x = 17', 'x = 5', 'x = 60'] },
                    { text: 'Решите: 2x + 3 = 11', answer: 'x = 4', options: ['x = 4', 'x = 7', 'x = 14', 'x = 8'] },
                    { text: 'Найдите корень: 5x - 7 = 3x + 5', answer: 'x = 6', options: ['x = 6', 'x = 12', 'x = 1', 'x = -1'] }
                ],
                independent: [
                    { text: 'Решите: 3x - 4 = 8', answer: 'x = 4' },
                    { text: 'Найдите x: 2(x + 3) = 10', answer: 'x = 2' }
                ],
                control: [
                    { text: '1. Решите: 3(x - 2) = 2(x + 4)', answer: 'x = 14' },
                    { text: '2. Составьте уравнение и решите: задумали число, прибавили 5, получили 12', answer: 'x + 5 = 12, x = 7' }
                ]
            }
        },
        '8класс': {
            'квадратные уравнения': {
                test: [
                    { text: 'Решите: x² - 5x + 6 = 0', answer: 'x = 2 или x = 3', options: ['x = 2 или x = 3', 'x = 1 или x = 6', 'нет решений', 'x = -2 или x = -3'] },
                    { text: 'Найдите D: x² + 4x + 3 = 0', answer: 'D = 4', options: ['D = 4', 'D = 16', 'D = 8', 'D = 2'] },
                    { text: 'Решите: x² = 16', answer: 'x = 4 или x = -4', options: ['x = 4 или x = -4', 'x = 4', 'x = -4', 'нет решений'] }
                ],
                independent: [
                    { text: 'Решите: x² - 9 = 0', answer: 'x = 3 или x = -3' },
                    { text: 'Решите: x² + 6x + 9 = 0', answer: 'x = -3' },
                    { text: 'Найдите корни: x² - 4x + 4 = 0', answer: 'x = 2' }
                ],
                control: [
                    { text: '1. Решите: 2x² - 5x + 2 = 0', answer: 'x = 2 или x = 0,5' },
                    { text: '2. Составьте квадратное уравнение с корнями 2 и 3', answer: 'x² - 5x + 6 = 0' },
                    { text: '3. Решите: x² + 2x - 8 = 0', answer: 'x = 2 или x = -4' }
                ]
            },
            'неравенства': {
                test: [
                    { text: 'Решите: x + 3 > 7', answer: 'x > 4', options: ['x > 4', 'x < 4', 'x = 4', 'x ≥ 4'] },
                    { text: 'Решите: 2x ≤ 10', answer: 'x ≤ 5', options: ['x ≤ 5', 'x ≥ 5', 'x < 5', 'x = 5'] },
                    { text: 'Что больше: 3 или √10?', answer: '3 > √10', options: ['3 > √10', '3 < √10', '3 = √10', 'не знаю'] }
                ],
                independent: [
                    { text: 'Решите: x - 5 < 3', answer: 'x < 8' },
                    { text: 'Решите: -2x ≥ 6', answer: 'x ≤ -3' }
                ],
                control: [
                    { text: '1. Решите неравенство: 3x - 2 > x + 4', answer: 'x > 3' },
                    { text: '2. Найдите целые решения: -2 ≤ x < 3', answer: '-2, -1, 0, 1, 2' }
                ]
            }
        },
        '9класс': {
            'квадратичная функция': {
                test: [
                    { text: 'Найдите вершину параболы y = x² - 4x + 3', answer: '(2, -1)', options: ['(2, -1)', '(2, 1)', '(4, -1)', '(4, 1)'] },
                    { text: 'Определите направление ветвей: y = -2x²', answer: 'вниз', options: ['вниз', 'вверх', 'вправо', 'влево'] },
                    { text: 'Найдите нули: x² - 4 = 0', answer: 'x = 2 или x = -2', options: ['x = 2 или x = -2', 'x = 2', 'x = -2', 'нет нулей'] }
                ],
                independent: [
                    { text: 'Постройте график y = x² - 1. Найдите y при x = 3.', answer: 'y = 8' },
                    { text: 'Определите область значений: y = x² + 2', answer: 'y ≥ 2' }
                ],
                control: [
                    { text: '1. Постройте график y = (x - 2)² + 1 и найдите точку пересечения с осью y', answer: '(0, 5)' }
                ]
            },
            'прогрессии': {
                test: [
                    { text: 'Найдите 5-й член арифметической прогрессии: 2, 5, 8...', answer: '14', options: ['14', '11', '17', '13'] },
                    { text: 'Найдите сумму первых 5 членов: 1, 3, 5...', answer: '25', options: ['25', '20', '30', '15'] },
                    { text: 'Найдите 4-й член геометрической прогрессии: 2, 4, 8...', answer: '16', options: ['16', '12', '10', '8'] }
                ],
                independent: [
                    { text: 'Дано: a₁ = 3, d = 2. Найдите a₁₀', answer: 'a₁₀ = 21' },
                    { text: 'Найдите сумму: 1 + 2 + 4 + 8', answer: '15' }
                ],
                control: [
                    { text: '1. Найдите сумму арифметической прогрессии: a₁ = 1, a₁₀ = 19, n = 10', answer: 'S₁₀ = 100' },
                    { text: '2. Найдите 6-й член геометрической прогрессии: 3, 6, 12...', answer: '96' }
                ]
            }
        }
    },
    // ==================== ГЕОМЕТРИЯ ====================
    'Геометрия': {
        '7класс': {
            'треугольники': {
                test: [
                    { text: 'Чему равна сумма углов треугольника?', answer: '180°', options: ['180°', '360°', '90°', '270°'] },
                    { text: 'Стороны треугольника 3, 4, 5. Какой это треугольник?', answer: 'прямоугольный', options: ['прямоугольный', 'остроугольный', 'тупоугольный', 'равнобедренный'] },
                    { text: 'В равнобедренном треугольнике угол при вершине 40°. Найдите углы при основании.', answer: '70° и 70°', options: ['70° и 70°', '40° и 40°', '70° и 40°', '80° и 80°'] },
                    { text: 'Медиана в треугольнике - это...', answer: 'отрезок к середине стороны', options: ['отрезок к середине стороны', 'биссектриса угла', 'высота', 'перпендикуляр'] }
                ],
                independent: [
                    { text: 'Найдите третий угол: 45° и 55°', answer: '80°' },
                    { text: 'Постройте треугольник со сторонами 3, 4, 5 см.', answer: 'Проверка построения' }
                ],
                control: [
                    { text: '1. Докажите, что треугольник со сторонами 5, 12, 13 - прямоугольный.', answer: '5² + 12² = 13²' },
                    { text: '2. В треугольнике ABC: ∠A = 50°, ∠B = 60°. Найдите ∠C.', answer: '∠C = 70°' }
                ]
            },
            'параллельные прямые': {
                test: [
                    { text: 'При пересечении двух параллельных прямых секущей образовались односторонние углы 70° и 110°. Сумма равна?', answer: '180°', options: ['180°', '70°', '110°', '360°'] },
                    { text: 'Если соответственные углы равны, то прямые...', answer: 'параллельны', options: ['параллельны', 'перпендикулярны', 'пересекаются', 'совпадают'] },
                    { text: 'Сумма односторонних углов при параллельных прямых = ?', answer: '180°', options: ['180°', '90°', '360°', '0°'] }
                ],
                independent: [
                    { text: 'Дано: ∠1 = 70°, ∠2 = 110°. Параллельны ли прямые?', answer: 'да' }
                ],
                control: [
                    { text: '1. Докажите параллельность: ∠A = 45°, ∠B = 135°', answer: 'Сумма = 180°, значит параллельны' }
                ]
            }
        },
        '8класс': {
            'четырёхугольники': {
                test: [
                    { text: 'Сумма углов выпуклого четырёхугольника?', answer: '360°', options: ['360°', '180°', '540°', '720°'] },
                    { text: 'В параллелограмме противоположные углы...', answer: 'равны', options: ['равны', 'в сумме 180°', 'в сумме 360°', 'прямые'] },
                    { text: 'Ромб - это...', answer: 'параллелограмм с равными сторонами', options: ['параллелограмм с равными сторонами', 'прямоугольник', 'квадрат', 'трапеция'] }
                ],
                independent: [
                    { text: 'В параллелограмме стороны 5 и 8. Найдите периметр.', answer: 'P = 26' }
                ],
                control: [
                    { text: '1. В ромбе сторона 6 см, высота 4 см. Найдите площадь.', answer: 'S = 24 см²' }
                ]
            },
            'площадь': {
                test: [
                    { text: 'Площадь квадрата 64 см². Чему равна сторона?', answer: '8 см', options: ['8 см', '6 см', '7 см', '9 см'] },
                    { text: 'Найдите площадь круга r = 3 см (π ≈ 3,14)', answer: '≈28,26 см²', options: ['≈28,26 см²', '≈9,42 см²', '≈18,84 см²', '≈37,68 см²'] },
                    { text: 'Площадь прямоугольника 40 см², ширина 5 см. Найдите длину.', answer: '8 см', options: ['8 см', '6 см', '10 см', '7 см'] }
                ],
                independent: [
                    { text: 'Найдите площадь треугольника с основанием 10 см и высотой 6 см.', answer: '30 см²' }
                ],
                control: [
                    { text: 'Найдите площадь фигуры: прямоугольник 10×6 см + полукруг r=3 см', answer: '≈74,13 см²' }
                ]
            }
        }
    },
    // ==================== ФИЗИКА ====================
    'Физика': {
        '7класс': {
            'механическое движение': {
                test: [
                    { text: 'Переведите 72 км/ч в м/с', answer: '20 м/с', options: ['20 м/с', '25 м/с', '15 м/с', '30 м/с'] },
                    { text: 'Автомобиль едет 60 км/ч. Какое расстояние за 2 часа?', answer: '120 км', options: ['120 км', '30 км', '180 км', '60 км'] },
                    { text: 'Скорость света ≈ 300 000 км/с. За 1 секунду:', answer: '300 000 км', options: ['300 000 км', '3 000 км', '30 000 км', '3 000 000 км'] },
                    { text: 'Формула скорости равномерного движения:', answer: 'v = s/t', options: ['v = s/t', 'v = st', 'v = t/s', 'v = s + t'] }
                ],
                independent: [
                    { text: 'Расстояние 240 км, скорость 80 км/ч. Время?', answer: '3 часа' },
                    { text: 'Спортсмен бежит 100 м за 10 с. Найдите скорость.', answer: '10 м/с' }
                ],
                control: [
                    { text: '1. Расстояние 120 км, скорость 60 км/ч. На обратный путь 40 км/ч. Средняя скорость?', answer: '48 км/ч' }
                ]
            },
            'сила': {
                test: [
                    { text: 'Единица измерения силы?', answer: 'Ньютон (Н)', options: ['Ньютон (Н)', 'Килограмм (кг)', 'Метр (м)', 'Ватт (Вт)'] },
                    { text: 'F = ma. Если m = 5 кг, a = 2 м/с², то F = ?', answer: '10 Н', options: ['10 Н', '7 Н', '3 Н', '2,5 Н'] },
                    { text: 'Сила тяжести F = mg. g ≈ ?', answer: '9,8 м/с²', options: ['9,8 м/с²', '10 м/с²', '1 м/с²', '98 м/с²'] }
                ],
                independent: [
                    { text: 'Найдите силу, действующую на тело массой 10 кг с ускорением 2 м/с².', answer: '20 Н' }
                ],
                control: [
                    { text: '1. На тело массой 5 кг действует сила 20 Н. Найдите ускорение.', answer: '4 м/с²' }
                ]
            }
        },
        '8класс': {
            'тепловые явления': {
                test: [
                    { text: 'Формула количества теплоты: Q = ...', answer: 'cm(t₂ - t₁)', options: ['cm(t₂ - t₁)', 'mgh', 'mv²/2', 'F/s'] },
                    { text: 'Удельная теплоёмкость воды:', answer: '4200 Дж/(кг·°С)', options: ['4200 Дж/(кг·°С)', '2100 Дж/(кг·°С)', '420 Дж/(кг·°С)', '42000 Дж/(кг·°С)'] },
                    { text: 'При плавлении температура...', answer: 'не изменяется', options: ['не изменяется', 'увеличивается', 'уменьшается', 'сначала увеличивается'] }
                ],
                independent: [
                    { text: 'Какое количество теплоты нужно для нагрева 2 кг воды на 10°С?', answer: 'Q = 84 кДж' }
                ],
                control: [
                    { text: '1. Смешали 1 кг воды при 20°С и 1 кг при 80°С. Найдите температуру смеси.', answer: '50°С' }
                ]
            },
            'электричество': {
                test: [
                    { text: 'Закон Ома:', answer: 'I = U/R', options: ['I = U/R', 'I = UR', 'I = R/U', 'I = U + R'] },
                    { text: 'Мощность тока P = ...', answer: 'UI', options: ['UI', 'U/I', 'I/R', 'R/I'] },
                    { text: 'Сопротивление проводника зависит от...', answer: 'длины, сечения, материала', options: ['длины, сечения, материала', 'силы тока', 'напряжения', 'времени'] }
                ],
                independent: [
                    { text: 'Найдите силу тока: U = 12 В, R = 4 Ом', answer: 'I = 3 А' }
                ],
                control: [
                    { text: '1. Резистор R = 10 Ом, I = 2 А. Найдите мощность.', answer: 'P = 40 Вт' }
                ]
            }
        }
    },
    // ==================== ХИМИЯ ====================
    'Химия': {
        '8класс': {
            'атомы и молекулы': {
                test: [
                    { text: 'Атом состоит из...', answer: 'ядра и электронов', options: ['ядра и электронов', 'только ядра', 'молекул', 'протонов'] },
                    { text: 'Число протонов в атоме = ...', answer: 'порядковому номеру', options: ['порядковому номеру', 'атомной массе', 'числу нейтронов', 'валентности'] },
                    { text: 'Изотопы отличаются числом...', answer: 'нейтронов', options: ['нейтронов', 'протонов', 'электронов', 'валентностью'] }
                ],
                independent: [
                    { text: 'Сколько электронов в атоме кислорода (O)?', answer: '8' }
                ],
                control: [
                    { text: '1. Определите число протонов, нейтронов и электронов в атоме углерода-12', answer: 'p=6, n=6, e=6' }
                ]
            },
            'химические реакции': {
                test: [
                    { text: 'Расставьте коэффициенты: Fe + O₂ → Fe₂O₃', answer: '4Fe + 3O₂ → 2Fe₂O₃', options: ['4Fe + 3O₂ → 2Fe₂O₃', 'Fe + O₂ → Fe₂O₃', '2Fe + 3O₂ → 2Fe₂O₃', '4Fe + O₂ → 2Fe₂O₃'] },
                    { text: 'Тип реакции: Fe + O₂ → Fe₂O₃', answer: 'соединения', options: ['соединения', 'разложения', 'замещения', 'обмена'] },
                    { text: 'Расставьте: H₂ + O₂ → H₂O', answer: '2H₂ + O₂ → 2H₂O', options: ['2H₂ + O₂ → 2H₂O', 'H₂ + O₂ → H₂O', '2H₂ + 2O₂ → 2H₂O', 'H₂ + 2O₂ → H₂O'] }
                ],
                independent: [
                    { text: 'Расставьте: Al + O₂ → Al₂O₃', answer: '4Al + 3O₂ → 2Al₂O₃' }
                ],
                control: [
                    { text: '1. Составьте уравнение горения метана: CH₄ + O₂ → CO₂ + H₂O', answer: 'CH₄ + 2O₂ → CO₂ + 2H₂O' }
                ]
            }
        }
    },
    // ==================== РУССКИЙ ЯЗЫК ====================
    'Русский язык': {
        '7класс': {
            'причастие': {
                test: [
                    { text: 'Найдите причастие: "Машина, остановленная водителем, стояла у дома."', answer: 'остановленная', options: ['остановленная', 'стояла', 'машина', 'домой'] },
                    { text: 'Какое причастие от глагола "читать"?', answer: 'читающий', options: ['читающий', 'прочитавший', 'читаемый', 'прочитан'] },
                    { text: 'Вид причастия "бегущий":', answer: 'настоящее действительное', options: ['настоящее действительное', 'прошедшее действительное', 'настоящее страдательное'] }
                ],
                independent: [
                    { text: 'Выпишите причастия из текста, укажите их вид.', answer: 'Проверка' },
                    { text: 'Образуйте причастия от глагола "строить".', answer: 'строящий, строивший, строимый, построенный' }
                ],
                control: [
                    { text: '1. Спишите, раскрывая скобки. Подчеркните причастия.', answer: 'Проверка' },
                    { text: '2. Выполните разбор причастия "написанная".', answer: 'прич., страд., прош., ж.р., ед.ч., И.п.' }
                ]
            },
            'деепричастие': {
                test: [
                    { text: 'Найдите деепричастие:', answer: 'читая', options: ['читая', 'читающий', 'прочитал', 'читаемый'] },
                    { text: 'Вид деепричастия "пройдя"?', answer: 'совершенный', options: ['совершенный', 'несовершенный', 'неопределённый'] },
                    { text: 'Деепричастный оборот выделяется:', answer: 'запятыми', options: ['запятыми', 'скобками', 'тире', 'двоеточием'] }
                ],
                independent: [
                    { text: 'Расставьте: "Он шёл улыбаясь".', answer: 'Он шёл, улыбаясь.' },
                    { text: 'Образуйте деепричастия от глагола "говорить".', answer: 'говоря, сказав' }
                ],
                control: [
                    { text: '1. Спишите, расставляя знаки. Объясните.', answer: 'Проверка' }
                ]
            }
        },
        '8класс': {
            'имя существительное': {
                test: [
                    { text: 'Склонение "река"?', answer: '1-е склонение', options: ['1-е склонение', '2-е склонение', '3-е склонение'] },
                    { text: 'Падеж "в школе":', answer: 'предложный', options: ['предложный', 'родительный', 'дательный', 'винительный'] },
                    { text: 'Существительное 3-го склонения:', answer: 'дочь', options: ['дочь', 'дом', 'окно', 'гора'] }
                ],
                independent: [
                    { text: 'Просклоняйте "гора".', answer: 'гора - горы - горе - гору - горой - о горе' },
                    { text: 'Образуйте Р.п. мн.ч.: окно, дерево, брат.', answer: 'окон, деревьев, братьев' }
                ],
                control: [
                    { text: '1. Выполните морфологический разбор "в лесу".', answer: 'лесу - сущ., м.р., 2-е скл., П.п.' }
                ]
            },
            'глагол': {
                test: [
                    { text: 'Спряжение "читать"?', answer: '1 спряжение', options: ['1 спряжение', '2 спряжение'] },
                    { text: 'Форма 2-го лица мн.ч. "читать":', answer: 'читаете', options: ['читаете', 'читаешь', 'читают', 'читай'] },
                    { text: 'Глагол "написать" - вид:', answer: 'совершенный', options: ['совершенный', 'несовершенный'] }
                ],
                independent: [
                    { text: 'Выпишите глаголы совершенного вида.', answer: 'написать, сказать' },
                    { text: 'Образуйте повелительное наклонение "читать".', answer: 'читай(те)' }
                ],
                control: [
                    { text: '1. Выполните морфологический разбор "прочитаю".', answer: 'глаг., сов.в., 1-е спр., буд.в., 1-е л., ед.ч.' }
                ]
            }
        }
    },
    // ==================== БИОЛОГИЯ ====================
    'Биология': {
        '7класс': {
            'животные': {
                test: [
                    { text: 'К какому типу относятся рыбы?', answer: 'Хордовые', options: ['Хордовые', 'Членистоногие', 'Моллюски', 'Кишечнополостные'] },
                    { text: 'Какой орган дыхания у рыб?', answer: 'жабры', options: ['жабры', 'лёгкие', 'трахея', 'кожа'] },
                    { text: 'Укажите класс млекопитающих:', answer: 'Млекопитающие', options: ['Млекопитающие', 'Птицы', 'Пресмыкающиеся', 'Земноводные'] }
                ],
                independent: [
                    { text: 'Перечислите системы органов рыб.', answer: 'пищеварительная, дыхательная, кровеносная, нервная, выделительная' }
                ],
                control: [
                    { text: '1. Сравните строение рыб и земноводных.', answer: 'Таблица сравнения' }
                ]
            }
        },
        '8класс': {
            'человек': {
                test: [
                    { text: 'Какой орган - "насос"?', answer: 'сердце', options: ['сердце', 'печень', 'лёгкие', 'мозг'] },
                    { text: 'Сколько костей в скелете взрослого человека?', answer: '≈206', options: ['≈206', '≈100', '≈300', '≈150'] },
                    { text: 'Где образуются эритроциты?', answer: 'в костном мозге', options: ['в костном мозге', 'в печени', 'в селезёнке', 'в сердце'] }
                ],
                independent: [
                    { text: 'Нарисуйте и подпишите основные системы органов человека.', answer: 'Проверка' }
                ],
                control: [
                    { text: '1. Опишите механизм дыхания человека.', answer: 'Вдох - диафрагма опускается, лёгкие расширяются. Выдох - диафрагма поднимается.' }
                ]
            }
        }
    },
    // ==================== ИСТОРИЯ ====================
    'История': {
        'default': {
            test: [
                { text: 'В каком году была Куликовская битва?', answer: '1380', options: ['1380', '1480', '1280', '1180'] },
                { text: 'Кто был первым русским царём?', answer: 'Иван IV Грозный', options: ['Иван IV Грозный', 'Пётр I', 'Иван III', 'Владимир'] },
                { text: 'Назовите дату начала ВОВ', answer: '22 июня 1941', options: ['22 июня 1941', '1 сентября 1939', '9 мая 1945', '12 июня 1990'] }
            ],
            independent: [
                { text: 'Подготовьте сообщение о полководце Великой отечественной войны.', answer: 'Проверка' }
            ],
            control: [
                { text: '1. Напишите эссе о значимом историческом событии.', answer: 'Оценивается' }
            ]
        }
    },
    // ==================== ГЕОГРАФИЯ ====================
    'География': {
        'default': {
            test: [
                { text: 'Самая длинная река в мире?', answer: 'Нил (или Амазонка - зависит от классификации)', options: ['Нил', 'Амазонка', 'Волга', 'Миссисипи'] },
                { text: 'Сколько материков на Земле?', answer: '6', options: ['6', '5', '7', '4'] },
                { text: 'Самая высокая гора мира?', answer: 'Эверест (Джомолунгма)', options: ['Эверест', 'К2', 'Аконкагуа', 'Эльбрус'] }
            ],
            independent: [
                { text: 'Опишите географическое положение России.', answer: 'Проверка' }
            ],
            control: [
                { text: '1. Подготовьте доклад о природной зоне России.', answer: 'Оценивается' }
            ]
        }
    },
    // ==================== ОКРУЖАЮЩИЙ МИР ====================
    'Окружающий мир': {
        '4класс': {
            'природные зоны': {
                test: [
                    { text: 'В какой зоне растут кактусы?', answer: 'в пустыне', options: ['в пустыне', 'в тундре', 'в тайге', 'в степи'] },
                    { text: 'Какое животное живёт в тундре?', answer: 'песец', options: ['песец', 'верблюд', 'медведь', 'лиса'] },
                    { text: 'Растения степи - это...', answer: 'травы и злаки', options: ['травы и злаки', 'хвойные деревья', 'кактусы', 'мхи и лишайники'] }
                ],
                independent: [
                    { text: 'Нарисуйте карту природных зон России.', answer: 'Проверка' }
                ],
                control: [
                    { text: '1. Опишите природную зону вашего региона.', answer: 'Творческое задание' }
                ]
            },
            'организм человека': {
                test: [
                    { text: 'Сколько у человека органов чувств?', answer: '5', options: ['5', '4', '6', '3'] },
                    { text: 'Какой орган отвечает за движение?', answer: 'мышцы', options: ['мышцы', 'кости', 'сердце', 'мозг'] },
                    { text: 'Для чего нужна пища?', answer: 'для энергии и роста', options: ['для энергии и роста', 'для удовольствия', 'для работы', 'для сна'] }
                ],
                independent: [
                    { text: 'Нарисуйте схему пищеварения.', answer: 'Проверка' }
                ],
                control: [
                    { text: '1. Расскажите о строении и функциях организма человека.', answer: 'Оценивается' }
                ]
            }
        }
    }
};

// ==================== ФУНКЦИИ ГЕНЕРАЦИИ ====================

// Найти задания по теме с учётом класса
function findTasksForTopic(classLevel, subject, topic, type) {
    const topicLower = topic.toLowerCase();
    const classKey = classLevel + 'класс';
    
    // 1. Ищем в базе с учётом класса
    if (taskDatabase[subject]) {
        // Сначала ищем по классу
        if (taskDatabase[subject][classKey]) {
            const classTasks = taskDatabase[subject][classKey];
            for (const [key, tasks] of Object.entries(classTasks)) {
                if (key === 'default') continue;
                if (topicLower.includes(key) || key.includes(topicLower)) {
                    return tasks[type] || tasks['test'] || tasks['independent'];
                }
            }
        }
        
        // Потом ищем универсальные для предмета
        for (const [key, tasks] of Object.entries(taskDatabase[subject])) {
            if (key === 'default' || key.includes('класс')) continue;
            if (topicLower.includes(key) || key.includes(topicLower)) {
                return tasks[type] || tasks['test'] || tasks['independent'];
            }
        }
        
        // Ищем по ключевым словам
        const keywords = topicLower.split(/[\s,.-]+/).filter(k => k.length > 2);
        for (const keyword of keywords) {
            for (const [key, tasks] of Object.entries(taskDatabase[subject])) {
                if (key === 'default' || key.includes('класс')) continue;
                if (key.includes(keyword)) {
                    return tasks[type] || tasks['test'] || tasks['independent'];
                }
            }
        }
    }
    
    // 2. Ищем в default для любого предмета
    for (const [subj, data] of Object.entries(taskDatabase)) {
        for (const [key, tasks] of Object.entries(data)) {
            if (key === 'default') continue;
            if (topicLower.includes(key) || key.includes(topicLower)) {
                return tasks[type] || tasks['test'] || tasks['independent'];
            }
        }
    }
    
    return null;
}

// Генерация уникальных заданий для всех вариантов - без повторений ВООБЩЕ
function generateUniqueTasksGlobal(classLevel, subject, topic, type, count, variantIndex = 0) {
    let tasks = findTasksForTopic(classLevel, subject, topic, type);
    
    if (!tasks || tasks.length === 0) {
        tasks = generateUniversalTasks(topic, type, count * 10);
    }
    
    // Перемешиваем
    let shuffled = shuffleArray([...tasks]);
    
    // Дополнительное перемешивание для разных вариантов
    if (variantIndex > 0) {
        for (let i = 0; i < variantIndex * 7; i++) {
            shuffled = shuffleArray(shuffled);
        }
    }
    
    const result = [];
    
    // Берём задания которые ещё НЕ использовались вообще
    for (const task of shuffled) {
        if (result.length >= count) break;
        if (!globalUsedTasks.has(task.text)) {
            result.push(task);
            globalUsedTasks.add(task.text); // Помечаем как использованное
        }
    }
    
    return shuffleArray(result);
}

// Генерация уникальных заданий - повторение только 1 раз если мало заданий
function generateUniqueTasks(classLevel, subject, topic, type, count, variantIndex = 0) {
    let tasks = findTasksForTopic(classLevel, subject, topic, type);
    
    if (!tasks || tasks.length === 0) {
        tasks = generateUniversalTasks(topic, type, count);
    }
    
    // Перемешиваем исходный массив
    let shuffled = shuffleArray([...tasks]);
    
    // Дополнительное перемешивание для разных вариантов
    if (variantIndex > 0) {
        for (let i = 0; i < variantIndex * 5; i++) {
            shuffled = shuffleArray(shuffled);
        }
    }
    
    const result = [];
    const usedTexts = new Set();
    
    // Первый проход - добавляем уникальные задания
    for (const task of shuffled) {
        if (result.length >= count) break;
        if (!usedTexts.has(task.text)) {
            result.push(task);
            usedTexts.add(task.text);
        }
    }
    
    // Если мало заданий - можно повторить только ОДИН раз
    if (result.length < count && shuffled.length > 0) {
        const uniqueOriginal = new Set(shuffled.map(t => t.text));
        
        // Второй проход - добавляем задания которых ещё не было (можно 1 раз повторить)
        for (const task of shuffled) {
            if (result.length >= count) break;
            if (!usedTexts.has(task.text)) {
                result.push(task);
                usedTexts.add(task.text);
            }
        }
    }
    
    // Если всё ещё мало - добавляем универсальные
    if (result.length < count) {
        const more = generateUniversalTasks(topic, type, count - result.length);
        for (const task of more) {
            if (result.length >= count) break;
            if (!usedTexts.has(task.text)) {
                result.push(task);
                usedTexts.add(task.text);
            }
        }
    }
    
    // Финальное перемешивание
    return shuffleArray(result);
}

// Генерация универсальных заданий
function generateUniversalTasks(topic, type, count) {
    const templates = {
        test: [
            { text: `Выполните задание по теме "${topic}"`, answer: 'Проверьте', options: ['А', 'Б', 'В', 'Г'] },
            { text: `Решите задачу: "${topic}"`, answer: 'Ответ', options: ['10', '15', '20', '25'] },
            { text: `Вычислите: 125 × 8 =`, answer: '1000', options: ['1000', '800', '100', '10000'] },
            { text: `Найдите значение выражения по теме "${topic}"`, answer: '25', options: ['25', '30', '35', '20'] },
            { text: `Выполните вычисления: 96 : 8 =`, answer: '12', options: ['12', '14', '10', '8'] }
        ],
        independent: [
            { text: `Выполните упражнения по теме "${topic}"`, answer: 'Проверьте по учебнику' },
            { text: `Решите задачу: 6 тетрадей стоят 72 рубля. Сколько стоит 1 тетрадь?`, answer: '12 рублей' },
            { text: `Вычислите: 24 × 13 =`, answer: '312' },
            { text: `Выполните задания по теме "${topic}"`, answer: 'Оценивается учителем' },
            { text: `Решите примеры по теме "${topic}"`, answer: 'Проверка' }
        ],
        control: [
            { text: `1. Выполните задания по теме "${topic}"`, answer: 'Оценивается' },
            { text: `2. Решите задачи по теме "${topic}"`, answer: 'Проверка' },
            { text: `3. Выполните контрольные задания`, answer: 'Итоговая оценка' }
        ]
    };
    
    const typeTemplates = templates[type] || templates['independent'];
    return shuffleArray([...typeTemplates]).slice(0, count);
}

// Перемешивание массива (Fisher-Yates)
function shuffleArray(array) {
    const arr = [...array];
    for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
}

// ==================== БАЗА ДАННЫХ ИСПОЛЬЗОВАННЫХ ЗАДАНИЙ ====================
// Загружаем использованные задания из localStorage
let globalUsedTasks = new Set(JSON.parse(localStorage.getItem('usedTasks') || '[]'));

// Сохраняем использованные задания в localStorage
function saveUsedTasks() {
    localStorage.setItem('usedTasks', JSON.stringify([...globalUsedTasks]));
}

// Очистить историю использованных заданий
function clearUsedTasks() {
    if (confirm('Очистить историю использованных заданий? Все задания снова будут доступны.')) {
        globalUsedTasks = new Set();
        saveUsedTasks();
        alert('✅ История очищена!');
    }
}

// ==================== СОХРАНЕНИЕ ВАРИАНТОВ ====================
let savedWorksheets = JSON.parse(localStorage.getItem('savedWorksheets') || '[]');

function saveCurrentWorksheet() {
    const data = {
        id: Date.now(),
        date: new Date().toLocaleDateString('ru-RU'),
        classLevel: classSelect.value,
        subject: subjectSelect.value,
        topic: lessonTopic.value,
        section: sectionNum.value,
        name: lessonName.value,
        type: workType.value,
        taskCount: taskCount.value,
        variantCount: variantCount.value,
        content: outputContent.innerHTML,
        answers: generatedAnswers
    };
    
    savedWorksheets.push(data);
    localStorage.setItem('savedWorksheets', JSON.stringify(savedWorksheets));
    renderSavedList();
    alert('✅ Вариант сохранён!');
}

function deleteSavedWorksheet(id) {
    if (confirm('Удалить этот вариант?')) {
        savedWorksheets = savedWorksheets.filter(w => w.id !== id);
        localStorage.setItem('savedWorksheets', JSON.stringify(savedWorksheets));
        renderSavedList();
    }
}

function loadSavedWorksheet(id) {
    const worksheet = savedWorksheets.find(w => w.id === id);
    if (worksheet) {
        outputContent.innerHTML = worksheet.content;
        outputSection.style.display = 'block';
        outputSection.scrollIntoView({ behavior: 'smooth' });
    }
}

function renderSavedList() {
    const list = document.getElementById('savedList');
    
    if (!list) return;
    
    if (savedWorksheets.length === 0) {
        list.innerHTML = '<p class="empty-message">У вас пока нет сохранённых вариантов</p>';
        return;
    }
    
    list.innerHTML = savedWorksheets.map(w => `
        <div class="saved-item">
            <div class="saved-info">
                <strong>${w.subject}</strong> - ${w.topic}<br>
                <small>${w.date} | ${w.classLevel} класс | ${w.variantCount} вар.</small>
            </div>
            <div class="saved-actions">
                <button onclick="loadSavedWorksheet(${w.id})">📖 Открыть</button>
                <button onclick="deleteSavedWorksheet(${w.id})" class="delete-btn">🗑️</button>
            </div>
        </div>
    `).join('');
}

// ==================== DOM ====================
const classSelect = document.getElementById('classSelect');
const subjectSelect = document.getElementById('subjectSelect');
const lessonTopic = document.getElementById('lessonTopic');
const sectionNum = document.getElementById('sectionNum');
const lessonName = document.getElementById('lessonName');
const workType = document.getElementById('workType');
const taskCount = document.getElementById('taskCount');
const variantCount = document.getElementById('variantCount');
const generatorForm = document.getElementById('generatorForm');
const outputSection = document.getElementById('outputSection');
const outputContent = document.getElementById('outputContent');
const editBtn = document.getElementById('editBtn');
const printBtn = document.getElementById('printBtn');
const newBtn = document.getElementById('newBtn');
const saveBtn = document.getElementById('saveBtn');

let generatedAnswers = [];

// Переключение вкладок
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const tabId = this.dataset.tab;
        
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById(tabId + '-tab').classList.add('active');
        
        if (tabId === 'saved') {
            renderSavedList();
        }
    });
});

// Обновление предметов
classSelect.addEventListener('change', function() {
    const classLevel = parseInt(this.value);
    const subjects = subjectsByClass[classLevel] || [];
    
    subjectSelect.innerHTML = '<option value="">Выберите предмет</option>';
    subjects.forEach(subject => {
        const option = document.createElement('option');
        option.value = subject;
        option.textContent = subject;
        subjectSelect.appendChild(option);
    });
    subjectSelect.disabled = false;
});

generatorForm.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const selectedClass = parseInt(classSelect.value);
    const subject = subjectSelect.value;
    const topic = lessonTopic.value;
    const section = sectionNum.value;
    const name = lessonName.value;
    const type = workType.value;
    const count = parseInt(taskCount.value);
    const variants = parseInt(variantCount.value);
    
    // НЕ сбрасываем использованные задания - они накапливаются!
    
    let html = '';
    let allAnswers = [];
    
    for (let v = 1; v <= variants; v++) {
        const variantLetter = getVariantLetter(v);
        const tasks = generateUniqueTasksGlobal(selectedClass, subject, topic, type, count, v - 1);
        
        html += generateWorksheetHTML(selectedClass, subject, topic, section, name, type, tasks, v, variantLetter);
        allAnswers.push({ variant: v, letter: variantLetter, answers: tasks.map(t => t.answer) });
    }
    
    // Сохраняем использованные задания в localStorage
    saveUsedTasks();
    
    outputContent.innerHTML = html;
    outputSection.style.display = 'block';
    generatedAnswers = allAnswers;
    outputSection.scrollIntoView({ behavior: 'smooth' });
});

function getVariantLetter(num) {
    const letters = 'АБВГДЕЁЖЗИКЛМНОПРСТУФХЦЧШЩЭЮЯ';
    return letters[(num - 1) % letters.length];
}

function generateWorksheetHTML(classLevel, subject, topic, section, name, type, tasks, variantNum, variantLetter) {
    const typeNames = {
        'test': 'Тест',
        'independent': 'Самостоятельная работа',
        'control': 'Контрольная работа'
    };
    
    let sectionInfo = section ? `<div class="worksheet-info"><strong>§ / Пункт:</strong> ${section}</div>` : '';
    
    let html = `
        <div class="worksheet">
            <div class="worksheet-header">
                <div class="worksheet-title">${typeNames[type]} - Вариант ${variantLetter}</div>
                <div class="worksheet-info"><strong>Предмет:</strong> ${subject}</div>
                <div class="worksheet-info"><strong>Класс:</strong> ${classLevel}</div>
                <div class="worksheet-info"><strong>Тема:</strong> ${topic}</div>
                ${sectionInfo}
                <div class="worksheet-info"><strong>Урок:</strong> ${name}</div>
                <div class="worksheet-info"><strong>Дата:</strong> ${new Date().toLocaleDateString('ru-RU')}</div>
            </div>
            <ul class="task-list">
    `;
    
    tasks.forEach((task, index) => {
        const cleanText = task.text.replace(/^\d+\.\s*/, '');
        
        if (type === 'test' && task.options) {
            let optionsHTML = task.options.map((opt, i) => `
                <div class="test-option">
                    <input type="radio" name="v${variantLetter}_t${index}" id="v${variantLetter}_t${index}_${i}">
                    <label for="v${variantLetter}_t${index}_${i}">${opt}</label>
                </div>
            `).join('');
            
            html += `
                <li class="task-item">
                    <span class="task-text">${index + 1}. ${cleanText}</span>
                    ${task.textFull ? `<div class="task-text-full"><em>${task.textFull}</em></div>` : ''}
                    <div class="test-options">${optionsHTML}</div>
                </li>
            `;
        } else {
            html += `
                <li class="task-item">
                    <span class="task-text">${index + 1}. ${cleanText}</span>
                    ${task.textFull ? `<div class="task-text-full"><em>${task.textFull}</em></div>` : ''}
                </li>
            `;
        }
    });
    
    html += `
            </ul>
            <div class="answer-section">
                <h3>Ответы - Вариант ${variantLetter} (для учителя)</h3>
                <ul class="answer-list">
    `;
    
    tasks.forEach((task, index) => {
        html += `<li class="answer-item">${index + 1}. ${task.answer}</li>`;
    });
    
    html += `
                </ul>
            </div>
        </div>
    `;
    
    return html;
}

// Кнопки
let isEditing = false;

editBtn.addEventListener('click', function() {
    isEditing = !isEditing;
    outputContent.contentEditable = isEditing;
    editBtn.textContent = isEditing ? '💾 Сохранить' : '✏️ Редактировать';
    if (!isEditing) outputContent.blur();
    else outputContent.focus();
});

printBtn.addEventListener('click', () => window.print());
saveBtn.addEventListener('click', saveCurrentWorksheet);

newBtn.addEventListener('click', () => {
    outputSection.style.display = 'none';
    generatorForm.reset();
    subjectSelect.innerHTML = '<option value="">Сначала выберите класс</option>';
    subjectSelect.disabled = true;
});

// Инициализация
renderSavedList();
