// База данных предметов по классам
const subjectsByClass = {
    1: ['Математика', 'Русский язык', 'Литературное чтение', 'Окружающий мир', 'ИЗО', 'Музыка', 'Физкультура'],
    2: ['Математика', 'Русский язык', 'Литературное чтение', 'Окружающий мир', 'ИЗО', 'Музыка', 'Физкультура'],
    3: ['Математика', 'Русский язык', 'Литературное чтение', 'Окружающий мир', 'ИЗО', 'Музыка', 'Физкультура'],
    4: ['Математика', 'Русский язык', 'Литературное чтение', 'Окружающий мир', 'ИЗО', 'Музыка', 'Физкультура'],
    5: ['Математика', 'Русский язык', 'Литература', 'Английский язык', 'История', 'География', 'Биология', 'ИЗО', 'Музыка', 'Физкультура'],
    6: ['Математика', 'Русский язык', 'Литература', 'Английский язык', 'История', 'География', 'Биология', 'Обществознание', 'ИЗО', 'Музыка', 'Физкультура'],
    7: ['Алгебра', 'Геометрия', 'Русский язык', 'Литература', 'Английский язык', 'Немецкий язык', 'История', 'География', 'Биология', 'Физика', 'Обществознание', 'ИЗО', 'Музыка', 'Физкультура'],
    8: ['Алгебра', 'Геометрия', 'Русский язык', 'Литература', 'Английский язык', 'Немецкий язык', 'История', 'География', 'Биология', 'Физика', 'Химия', 'Обществознание', 'Информатика', 'ИЗО', 'Физкультура'],
    9: ['Алгебра', 'Геометрия', 'Русский язык', 'Литература', 'Английский язык', 'Немецкий язык', 'История', 'География', 'Биология', 'Физика', 'Химия', 'Обществознание', 'Информатика', 'ОБЖ', 'Физкультура'],
    10: ['Алгебра', 'Геометрия', 'Русский язык', 'Литература', 'Английский язык', 'Немецкий язык', 'История', 'География', 'Биология', 'Физика', 'Химия', 'Обществознание', 'Информатика', 'ОБЖ', 'Физкультура', 'Экономика', 'Право', 'Астрономия'],
    11: ['Алгебра', 'Геометрия', 'Русский язык', 'Литература', 'Английский язык', 'Немецкий язык', 'История', 'География', 'Биология', 'Физика', 'Химия', 'Обществознание', 'Информатика', 'ОБЖ', 'Физкультура', 'Экономика', 'Право', 'Астрономия', 'Экология']
};

// База шаблонов заданий по темам - ПРАКТИЧЕСКИЕ задания
const topicTasks = {
    'Русский язык': {
        // Темы по русскому языку
        'причастный': {
            test: [
                { text: '1. Спишите текст, вставляя пропущенные буквы. Подчеркните причастия как члены предложения.', 
                  textFull: 'По берегам рек раскинулись древние дубы, покрытые толстой корой. Листья, осенённые первыми заморозками, медленно падали на землю.',
                  answer: 'раскинулись (прич.), покрытые (прич.), осенённые (прич.)', 
                  options: ['раскинулись (прич.), покрытые (прич.), осенённые (прич.)', 'стоящие (прич.), летящие (прич.), бегущие (прич.)', 'большие (прич.), маленькие (прич.), новые (прич.)', 'красивые (прич.), интересные (прич.), важные (прич.)'] },
                { text: '2. Выпишите из текста причастия с зависимыми словами.', 
                  textFull: 'Машина, остановленная водителем, стояла у дома. Девушка, читающая книгу, сидела на скамейке.',
                  answer: 'остановленная водителем, читающая книгу', 
                  options: ['остановленная водителем, читающая книгу', 'стоящая у дома, сидящая на скамейке', 'красивая машина, интересная книга', 'большой дом, новая скамейка'] },
                { text: '3. Определите вид причастия: бегущий, убежавший, бежавший.', 
                  answer: 'бегущий - н.в., убежавший - с.в., бежавший - н.в.', 
                  options: ['бегущий - н.в., убежавший - с.в., бежавший - н.в.', 'бегущий - с.в., убежавший - н.в., бежавший - с.в.', 'все н.в.', 'все с.в.'] },
                { text: '4. Образуйте от глагола причастия: читать, написать.', 
                  answer: 'читающий, читавший; написавший, написанный', 
                  options: ['читающий, читавший; написавший, написанный', 'читающий, написавший', 'прочитавший, пишущий', 'читаемый, пишущий'] }
            ],
            independent: [
                { text: '1. Спишите текст, вставляя пропущенные буквы. Подчеркните причастия.', 
                  textFull: 'На столе лежала книга, (не)прочитанная мной. Деревья, (по)крытые инеем, блестели на солнце. Ученик, (выполнивший) задание, получил оценку.' },
                { text: '2. Выпишите все причастия, укажите их вид (действительное/страдательное, настоящее/прошедшее).', 
                  textFull: 'Солнце, освещающее вершины гор, спряталось за тучи. Письмо, написанное братом, было отправлено вчера.' },
                { text: '3. Образуйте причастия от данных глаголов: строить, сказать, нести.', 
                  answer: 'строящий, строивший, построенный; говорящий, сказавший, сказанный; несущий, несший,несённый' },
                { text: '4. Составьте 3 предложения с причастными оборотами.', 
                  answer: 'Пример: Дом, построенный рабочими, стоит на берегу реки.' }
            ],
            control: [
                { text: '1. Спишите текст, раскрывая скобки, вставляя пропущенные буквы. Подчеркните причастия и причастные обороты.', 
                  textFull: 'На опушке леса мы увидели старый дуб, (у)крытый мхом. Река, (за)мерзшая в ноябре, скоро скроется подо льдом. Ученики, (при)шедшие рано, успели подготовиться к уроку.' },
                { text: '2. Выполните морфологический разбор причастия: (не)забываемые', answer: 'незабываемые - прич., н.в., действ., наст., мн.ч., И.п.' },
                { text: '3. Образуйте от глаголов все возможные причастия: везти, класть, думать.', answer: 'везущий, вёзший, везомый, привезённый; кладущий, клавший, кладомый, положенный; думающий, думавший, думаемый' },
                { text: '4. Синтаксический разбор предложения: Машина, остановленная шофёром, медленно тронулась с места.', answer: 'Грамматическая основа: машина тронулась. Причастный оборот: остановленная шофёром - определение.' },
                { text: '5. Составьте текст (5-6 предложений) с причастными оборотами на тему "Осень".', answer: 'Текст должен содержать не менее 3 причастных оборотов.' }
            ]
        },
        'деепричастный': {
            test: [
                { text: '1. Спишите, расставляя знаки препинания. Подчеркните деепричастия.', 
                  textFull: 'Он сидел у окна читал книгу. Мы шли по лесу наслаждались тишиной.',
                  answer: 'Он сидел у окна, читая книгу. Мы шли по лесу, наслаждаясь тишиной.', 
                  options: ['Он сидел у окна, читая книгу. Мы шли по лесу, наслаждаясь тишиной.', 'Он сидел у окна читая книгу. Мы шли по лесу наслаждаясь тишиной.', 'Он сидел у окна; читая книгу. Мы шли по лесу; наслаждаясь тишиной.', 'Он сидел, у окна читая книгу. Мы шли, по лесу наслаждаясь тишиной.'] },
                { text: '2. Определите вид деепричастия: читая, прочитав, сидя, сев.', 
                  answer: 'читая - н.в., прочитав - с.в., сидя - н.в., сев - с.в.', 
                  options: ['читая - н.в., прочитав - с.в., сидя - н.в., сев - с.в.', 'читая - с.в., прочитав - н.в.', 'все н.в.', 'все с.в.'] },
                { text: '3. Образуйте деепричастия от глагола идти.', 
                  answer: 'идя, зайдя, перейдя', 
                  options: ['идя, зайдя, перейдя', 'идучи, шёл', 'хотя, прошёл', 'идущий, шедший'] }
            ],
            independent: [
                { text: '1. Спишите текст, расставляя знаки препинания. Выделите деепричастия и деепричастные обороты.', 
                  textFull: 'Птицы летят на юг опускаются на деревья. Ребёнок бежал смеялся.' },
                { text: '2. Выпишите деепричастия, определите их вид.', 
                  textFull: 'Он работал уставая. Отдохнув, мы пошли дальше. Понимая задачу, решил её быстро.' },
                { text: '3. Образуйте деепричастия несовершенного и совершенного вида от глаголов: говорить, сказать, делать, сделать.', 
                  answer: 'говоря, сказав; делая, сделав' },
                { text: '4. Составьте 3 предложения с деепричастными оборотами.', 
                  answer: 'Пример: Возвращаясь домой, я встретил друга.' }
            ],
            control: [
                { text: '1. Спишите текст, раскрывая скобки, расставляя знаки препинания.', 
                  textFull: '(Не)смотря на дождь мы вышли из дома. Он читал книгу (не)замечая времени. (С)делав уроки я пошёл гулять.' },
                { text: '2. Выполните морфологический разбор деепричастия: (не)годуя', answer: 'негодуя - дееприч., н.в., несов.в.' },
                { text: '3. Образуйте деепричастия от глаголов: везти, нести, брести, прибрести.', answer: 'везя, неся, бредя, прибредя (разг.) / принесши (устар.)' },
                { text: '4. Синтаксический разбор предложения: Читая книгу, я забыл о времени.', answer: 'Читая книгу - деепричастный оборот, обстоятельство времени.' },
                { text: '5. Составьте текст-описание (5-6 предложений) с деепричастными оборотами.', answer: 'Текст должен содержать не менее 3 деепричастных оборотов.' }
            ]
        },
        'имя существительное': {
            test: [
                { text: '1. Выпишите существительные 1-го склонения: дом, окно, река, море, поле, гора.', 
                  answer: 'река, гора (ж.р., 1-е скл.)', 
                  options: ['река, гора (ж.р., 1-е скл.)', 'дом, окно', 'море, поле', 'все 1-е скл.'] },
                { text: '2. Определите падеж существительного "в школе":', 
                  answer: 'П.п.', 
                  options: ['П.п.', 'Р.п.', 'Д.п.', 'В.п.'] }
            ],
            independent: [
                { text: '1. Просклоняйте существительное "река".', answer: 'И.п. река - Р.п. реки - Д.п. реке - В.п. реку - Т.п. рекой - П.п. о реке' },
                { text: '2. Выпишите существительные 3-го склонения: мать, путь, дочь, друг, окно, степь.', answer: 'мать, путь, дочь, степь' },
                { text: '3. Образуйте форму Р.п. мн.ч.: дом, окно, дерево, брат, друг.', answer: 'домов, окон, деревьев, братьев, друзей' }
            ],
            control: [
                { text: '1. Выполните морфологический разбор существительного "в лесу" (в лесу растут грибы).', answer: 'лесу - сущ., нариц., неодушевлённое, м.р., 2-е скл., П.п.' },
                { text: '2. Образуйте все формы косвенных падежей множественного числа: стул, дерево, крыло.', answer: 'стульев, стульям, стульями, о стульях; деревьев, деревьям, деревьями, о деревьях; крыльев, крыльям, крыльями, о крыльях' },
                { text: '3. Составьте 5 предложений с существительными разных склонений в разных падежах.', answer: 'Предложения должны содержать существительные 1, 2 и 3 склонений.' }
            ]
        },
        'глагол': {
            test: [
                { text: '1. Определите спряжение глаголов: читать, говорить, строить, учить.', 
                  answer: 'читать - 1 спр., говорить - 2 спр., строить - 2 спр., учить - 2 спр.', 
                  options: ['читать - 1 спр., говорить - 2 спр., строить - 2 спр., учить - 2 спр.', 'все 1 спр.', 'все 2 спр.', 'читать - 2 спр., говорить - 1 спр.'] },
                { text: '2. Образуйте форму 2-го лица множественного числа: читать, писать, говорить.', 
                  answer: 'читаете, пишете, говорите', 
                  options: ['читаете, пишете, говорите', 'читаете, пишите, говорите', 'читают, пишут, говорят', 'читал, писал, говорил'] }
            ],
            independent: [
                { text: '1. Выпишите глаголы совершенного вида: читать, написать, говорить, сказать, учить, выучить.', answer: 'написать, сказать, выучить' },
                { text: '2. Образуйте форму прошедшего времени женского рода: он читал - она ...', answer: 'она читала' },
                { text: '3. Составьте предложения с глаголами в изъявительном, условном и повелительном наклонениях.', answer: 'Примеры: Я читаю (изъяв.), Я бы читал (условн.), Читай! (повелит.)' }
            ],
            control: [
                { text: '1. Выполните морфологический разбор глагола "прочитаю":', answer: 'прочитаю - глаг., сов.в., 1-е спр., буд.в., 1-е л., ед.ч.' },
                { text: '2. Образуйте от данных глаголов все формы повелительного наклонения: читать, написать, взять.', answer: 'читай(те), напиши(те), возьми(те)' },
                { text: '3. Составьте текст (6-8 предложений) с глаголами разных наклонений.', answer: 'Текст должен содержать глаголы изъявительного, условного и повелительного наклонений.' }
            ]
        },
        // Для других тем русского языка - универсальные шаблоны
        'default': {
            test: [
                { text: '1. Выполните задание по теме. Проверьте свою работу.', 
                  answer: 'Правильный ответ зависит от конкретного задания', 
                  options: ['Вариант А', 'Вариант Б', 'Вариант В', 'Вариант Г'] }
            ],
            independent: [
                { text: '1. Выполните упражнение по теме урока.', answer: 'Проверьте по учебнику' },
                { text: '2. Выпишите примеры по теме из текста.', answer: 'Примеры из учебника' }
            ],
            control: [
                { text: '1. Выполните все задания по теме урока.', answer: 'Оценивается учителем' }
            ]
        }
    },
    'Математика': {
        // Сложение и вычитание
        'сложение': {
            test: [
                { text: '1. Вычислите: 25 + 17 = ?', answer: '42', options: ['42', '41', '43', '40'] },
                { text: '2. Вычислите: 156 + 244 = ?', answer: '400', options: ['390', '400', '410', '500'] },
                { text: '3. Решите уравнение: x + 15 = 38', answer: 'x = 23', options: ['x = 23', 'x = 53', 'x = 13', 'x = 33'] }
            ],
            independent: [
                { text: '1. Вычислите: 125 + 237 = ', answer: '362' },
                { text: '2. Вычислите: 543 + 189 = ', answer: '732' },
                { text: '3. Решите уравнение: x + 45 = 100', answer: 'x = 55' },
                { text: '4. Решите задачу: В одном классе 25 учеников, во втором - на 12 больше. Сколько учеников во втором классе?', answer: '37 учеников' }
            ],
            control: [
                { text: '1. Вычислите: 1245 + 3789 = ', answer: '5034' },
                { text: '2. Вычислите: 15000 + 23500 = ', answer: '38500' },
                { text: '3. Решите уравнение: x + 234 = 1000', answer: 'x = 766' },
                { text: '4. Решите задачу: На первой полке 125 книг, на второй - 87, на третьей - 93. Сколько книг на трёх полках?', answer: '305 книг' }
            ]
        },
        'вычитание': {
            test: [
                { text: '1. Вычислите: 45 - 17 = ?', answer: '28', options: ['28', '32', '26', '38'] },
                { text: '2. Вычислите: 100 - 36 = ?', answer: '64', options: ['64', '74', '54', '66'] }
            ],
            independent: [
                { text: '1. Вычислите: 356 - 128 = ', answer: '228' },
                { text: '2. Вычислите: 700 - 245 = ', answer: '455' },
                { text: '3. Решите уравнение: x - 18 = 42', answer: 'x = 60' }
            ],
            control: [
                { text: '1. Вычислите: 5000 - 1234 = ', answer: '3766' },
                { text: '2. Вычислите: 15000 - 7650 = ', answer: '7350' },
                { text: '3. Решите задачу: В автобусе было 45 пассажиров. На остановке вышли 18 человек. Сколько пассажиров осталось в автобусе?', answer: '27 пассажиров' }
            ]
        },
        'умножение': {
            test: [
                { text: '1. Вычислите: 12 × 7 = ?', answer: '84', options: ['84', '72', '96', '78'] },
                { text: '2. Вычислите: 15 × 6 = ?', answer: '90', options: ['90', '75', '105', '80'] }
            ],
            independent: [
                { text: '1. Вычислите: 24 × 13 = ', answer: '312' },
                { text: '2. Вычислите: 125 × 8 = ', answer: '1000' },
                { text: '3. Решите задачу: 6 тетрадей стоят 72 рубля. Сколько стоит 1 тетрадь?', answer: '12 рублей' }
            ],
            control: [
                { text: '1. Вычислите: 123 × 45 = ', answer: '5535' },
                { text: '2. Вычислите: 256 × 34 = ', answer: '8704' },
                { text: '3. Решите задачу: Длина прямоугольника 15 см, ширина 8 см. Найдите площадь.', answer: '120 см²' }
            ]
        },
        'деление': {
            test: [
                { text: '1. Вычислите: 84 : 7 = ?', answer: '12', options: ['12', '14', '10', '11'] },
                { text: '2. Вычислите: 96 : 8 = ?', answer: '12', options: ['12', '14', '10', '11'] }
            ],
            independent: [
                { text: '1. Вычислите: 312 : 13 = ', answer: '24' },
                { text: '2. Вычислите: 1000 : 25 = ', answer: '40' },
                { text: '3. Решите: x × 7 = 63', answer: 'x = 9' }
            ],
            control: [
                { text: '1. Вычислите: 5535 : 123 = ', answer: '45' },
                { text: '2. Вычислите: 8704 : 256 = ', answer: '34' },
                { text: '3. Решите задачу: 72 книги разложили на 6 полок поровну. Сколько книг на каждой полке?', answer: '12 книг' }
            ]
        },
        'дробь': {
            test: [
                { text: '1. Запишите в виде дроби: три седьмых', answer: '3/7', options: ['3/7', '7/3', '3/10', '7/10'] },
                { text: '2. Сравните дроби: 3/5 и 4/5', answer: '3/5 < 4/5', options: ['3/5 < 4/5', '3/5 > 4/5', '3/5 = 4/5', 'нельзя сравнить'] }
            ],
            independent: [
                { text: '1. Вычислите: 1/2 + 1/4 = ', answer: '3/4' },
                { text: '2. Вычислите: 2/3 × 3/4 = ', answer: '1/2' },
                { text: '3. Вычислите: 5/6 : 2/3 = ', answer: '5/4 = 1 1/4' }
            ],
            control: [
                { text: '1. Вычислите: (1/2 + 1/3) × 6 = ', answer: '5' },
                { text: '2. Решите уравнение: x/4 = 3/8', answer: 'x = 3/2 = 1,5' },
                { text: '3. Задача: Отрезали 2/5 ленты, что составляет 8 м. Какова длина всей ленты?', answer: '20 м' }
            ]
        },
        'уравнение': {
            test: [
                { text: '1. Решите уравнение: x + 5 = 12', answer: 'x = 7', options: ['x = 7', 'x = 17', 'x = 5', 'x = 60'] },
                { text: '2. Решите уравнение: x × 3 = 15', answer: 'x = 5', options: ['x = 5', 'x = 18', 'x = 45', 'x = 12'] }
            ],
            independent: [
                { text: '1. Решите уравнение: 2x + 7 = 15', answer: 'x = 4' },
                { text: '2. Решите уравнение: 3x - 5 = 16', answer: 'x = 7' },
                { text: '3. Решите: (x + 3) × 2 = 14', answer: 'x = 4' }
            ],
            control: [
                { text: '1. Решите уравнение: 2x + 3(x - 1) = 16', answer: 'x = 3,8' },
                { text: '2. Решите уравнение: (x + 5)/2 = 12', answer: 'x = 19' },
                { text: '3. Составьте уравнение для решения задачи: Задумали число, прибавили к нему 15, получили 40. Какое число задумали?', answer: 'x + 15 = 40, x = 25' }
            ]
        },
        'процент': {
            test: [
                { text: '1. Найдите 10% от 200', answer: '20', options: ['20', '10', '200', '2'] },
                { text: '2. Сколько процентов составляет 15 от 75?', answer: '20%', options: ['20%', '15%', '25%', '10%'] }
            ],
            independent: [
                { text: '1. Найдите 25% от 80', answer: '20' },
                { text: '2. Цена товара 500 руб. Скидка 15%. Сколько стоит товар со скидкой?', answer: '425 руб.' }
            ],
            control: [
                { text: '1. Вклад в банке 10000 руб. под 12% годовых. Сколько будет через год?', answer: '11200 руб.' },
                { text: '2. Цена товара повысилась с 800 до 960 руб. На сколько процентов повысилась цена?', answer: '20%' }
            ]
        },
        'default': {
            test: [
                { text: '1. Выполните вычисления', answer: 'Проверьте по образцу', options: ['Вариант А', 'Вариант Б', 'Вариант В', 'Вариант Г'] }
            ],
            independent: [
                { text: '1. Решите примеры по теме урока', answer: 'Проверьте по учебнику' }
            ],
            control: [
                { text: '1. Решите все задания по теме', answer: 'Оценивается учителем' }
            ]
        }
    },
    'Алгебра': {
        'квадратное уравнение': {
            test: [
                { text: '1. Решите уравнение: x² - 5x + 6 = 0', answer: 'x = 2 или x = 3', options: ['x = 2 или x = 3', 'x = 1 или x = 6', 'x = -2 или x = -3', 'нет решений'] },
                { text: '2. Найдите дискриминант: x² + 4x + 3 = 0', answer: 'D = 4', options: ['D = 4', 'D = 16', 'D = 8', 'D = 2'] }
            ],
            independent: [
                { text: '1. Решите уравнение: x² - 9 = 0', answer: 'x = 3 или x = -3' },
                { text: '2. Решите уравнение: x² + 6x + 9 = 0', answer: 'x = -3' }
            ],
            control: [
                { text: '1. Решите уравнение: 2x² - 5x + 2 = 0', answer: 'x = 2 или x = 0,5' },
                { text: '2. Составьте квадратное уравнение с корнями 2 и 3', answer: 'x² - 5x + 6 = 0' }
            ]
        },
        'функция': {
            test: [
                { text: '1. Найдите значение функции y = 2x + 1 при x = 3', answer: 'y = 7', options: ['y = 7', 'y = 6', 'y = 8', 'y = 5'] }
            ],
            independent: [
                { text: '1. Постройте график функции y = x + 2. Найдите y при x = 4.', answer: 'y = 6' }
            ],
            control: [
                { text: '1. Найдите точку пересечения графиков y = 2x и y = x + 3', answer: '(3, 6)' }
            ]
        },
        'default': {
            test: [{ text: '1. Выполните задание', answer: 'Ответ', options: ['А', 'Б', 'В', 'Г'] }],
            independent: [{ text: '1. Решите задачи по теме', answer: 'Проверьте' }],
            control: [{ text: '1. Решите все задания', answer: 'Оценивается' }]
        }
    },
    'Геометрия': {
        'треугольник': {
            test: [
                { text: '1. Чему равна сумма углов треугольника?', answer: '180°', options: ['180°', '360°', '90°', '270°'] }
            ],
            independent: [
                { text: '1. Найдите третий угол треугольника, если два угла равны 45° и 55°.', answer: '80°' }
            ],
            control: [
                { text: '1. Постройте треугольник со сторонами 3, 4, 5 см. Докажите, что он прямоугольный.', answer: '3² + 4² = 5²' }
            ]
        },
        'площадь': {
            test: [
                { text: '1. Найдите площадь прямоугольника со сторонами 5 см и 8 см', answer: '40 см²', options: ['40 см²', '26 см²', '13 см²', '80 см²'] }
            ],
            independent: [
                { text: '1. Найдите площадь треугольника с основанием 10 см и высотой 6 см.', answer: '30 см²' }
            ],
            control: [
                { text: '1. Найдите площадь круга с радиусом 5 см (π ≈ 3,14)', answer: '78,5 см²' }
            ]
        },
        'default': {
            test: [{ text: '1. Решите задачу', answer: 'Ответ', options: ['А', 'Б', 'В', 'Г'] }],
            independent: [{ text: '1. Выполните построения и вычисления', answer: 'Проверьте' }],
            control: [{ text: '1. Решите все задачи', answer: 'Оценивается' }]
        }
    },
    'Физика': {
        'скорость': {
            test: [
                { text: '1. Переведите 72 км/ч в м/с', answer: '20 м/с', options: ['20 м/с', '25 м/с', '15 м/с', '30 м/с'] }
            ],
            independent: [
                { text: '1. Автомобиль движется со скоростью 60 км/ч. Какое расстояние он проедет за 2 часа?', answer: '120 км' }
            ],
            control: [
                { text: '1. Расстояние между городами 240 км. Автомобиль выехал со скоростью 80 км/ч. Сколько времени он был в пути?', answer: '3 часа' }
            ]
        },
        'сила': {
            test: [
                { text: '1. Какая физическая величина измеряется в ньютонах?', answer: 'Сила', options: ['Сила', 'Масса', 'Скорость', 'Время'] }
            ],
            independent: [
                { text: '1. На тело массой 5 кг действует сила 20 Н. Найдите ускорение.', answer: '4 м/с²' }
            ],
            control: [
                { text: '1. Найдите силу тяжести, действующую на тело массой 10 кг (g = 10 м/с²).', answer: '100 Н' }
            ]
        },
        'default': {
            test: [{ text: '1. Ответьте на вопрос', answer: 'Ответ', options: ['А', 'Б', 'В', 'Г'] }],
            independent: [{ text: '1. Решите задачу', answer: 'Проверьте' }],
            control: [{ text: '1. Решите все задачи', answer: 'Оценивается' }]
        }
    },
    'Химия': {
        'уравнение реакции': {
            test: [
                { text: '1. Расставьте коэффициенты: Fe + O₂ → Fe₂O₃', answer: '4Fe + 3O₂ → 2Fe₂O₃', options: ['4Fe + 3O₂ → 2Fe₂O₃', 'Fe + O₂ → Fe₂O₃', '2Fe + 3O₂ → 2Fe₂O₃', '4Fe + O₂ → 2Fe₂O₃'] }
            ],
            independent: [
                { text: '1. Расставьте коэффициенты: H₂ + O₂ → H₂O', answer: '2H₂ + O₂ → 2H₂O' }
            ],
            control: [
                { text: '1. Составьте уравнение реакции горения метана CH₄ + O₂ → CO₂ + H₂O и расставьте коэффициенты', answer: 'CH₄ + 2O₂ → CO₂ + 2H₂O' }
            ]
        },
        'default': {
            test: [{ text: '1. Ответьте на вопрос', answer: 'Ответ', options: ['А', 'Б', 'В', 'Г'] }],
            independent: [{ text: '1. Выполните задание', answer: 'Проверьте' }],
            control: [{ text: '1. Решите задачи', answer: 'Оценивается' }]
        }
    },
    'Биология': {
        'клетка': {
            test: [
                { text: '1. Какая органелла является "энергетической станцией" клетки?', answer: 'Митохондрия', options: ['Митохондрия', 'Рибосома', 'Ядро', 'Вакуоль'] }
            ],
            independent: [
                { text: '1. Нарисуйте и подпишите основные органоиды клетки.', answer: 'Проверьте по учебнику' }
            ],
            control: [
                { text: '1. Сравните растительную и животную клетки. Составьте таблицу.', answer: 'Таблица с признаками сходства и различий' }
            ]
        },
        'default': {
            test: [{ text: '1. Ответьте на вопрос', answer: 'Ответ', options: ['А', 'Б', 'В', 'Г'] }],
            independent: [{ text: '1. Выполните задание', answer: 'Проверьте' }],
            control: [{ text: '1. Решите задачи', answer: 'Оценивается' }]
        }
    },
    'История': {
        'default': {
            test: [{ text: '1. Дайте краткий ответ на вопрос', answer: 'Ответ', options: ['А', 'Б', 'В', 'Г'] }],
            independent: [{ text: '1. Подготовьте развёрнутый ответ', answer: 'Проверьте' }],
            control: [{ text: '1. Напишите развёрнутый ответ на вопрос', answer: 'Оценивается' }]
        }
    },
    'default': {
        default: {
            test: [{ text: '1. Выполните задание', answer: 'Ответ', options: ['А', 'Б', 'В', 'Г'] }],
            independent: [{ text: '1. Выполните задание по теме', answer: 'Проверьте' }],
            control: [{ text: '1. Выполните все задания', answer: 'Оценивается' }]
        }
    }
};

// Функция поиска заданий по теме
function findTasksByTopic(subject, topic, type) {
    const subjectTasks = topicTasks[subject] || topicTasks['default'];
    const topicLower = topic.toLowerCase();
    
    // Ищем совпадение по ключевым словам темы
    for (const [key, tasks] of Object.entries(subjectTasks)) {
        if (key === 'default') continue;
        if (topicLower.includes(key)) {
            return tasks[type] || tasks['test'] || tasks['independent'];
        }
    }
    
    // Если не нашли - возвращаем задания по умолчанию для предмета
    const defaultTasks = subjectTasks['default'];
    if (defaultTasks && defaultTasks[type]) {
        return defaultTasks[type];
    }
    
    return null;
}

// Функция генерации заданий
function generateTasks(subject, topic, classLevel, type, count) {
    let tasks = findTasksByTopic(subject, topic, type);
    
    // Если нашли задания по теме
    if (tasks && tasks.length > 0) {
        // Перемешиваем задания случайным образом
        const shuffled = shuffleArray([...tasks]);
        // Дополняем или обрезаем до нужного количества
        return generateExactlyCountTasks(shuffled, count, subject, topic, type);
    }
    
    // Фоллбек - генерируем универсальные задания
    return generateGenericTasks(subject, topic, type, count);
}

// Перемешивание массива (алгоритм Fisher-Yates)
function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

// Генерируем ровно нужное количество заданий
function generateExactlyCountTasks(tasks, count, subject, topic, type) {
    const result = [];
    
    // Если заданий меньше чем нужно - дополняем из универсальных
    if (tasks.length < count) {
        // Добавляем все найденные задания в случайном порядке
        const shuffledFound = shuffleArray([...tasks]);
        result.push(...shuffledFound);
        
        // Дополняем до нужного количества универсальными
        const needed = count - tasks.length;
        const generic = generateGenericTasks(subject, topic, type, needed);
        result.push(...generic);
    } else {
        // Если заданий достаточно - берём нужное количество из перемешанного списка
        result.push(...tasks.slice(0, count));
    }
    
    // Ещё раз перемешиваем final результат
    return shuffleArray(result);
}

// Генерация универсальных заданий с разными формулировками
function generateGenericTasks(subject, topic, type, count) {
    const tasks = [];
    
    // Разные формулировки для универсальных заданий
    const mathTemplates = {
        test: [
            { text: 'Вычислите', answer: 'Проверьте', options: ['12', '14', '16', '18'] },
            { text: 'Решите уравнение', answer: 'x = ?', options: ['x = 5', 'x = 7', 'x = 3', 'x = 9'] },
            { text: 'Найдите значение выражения', answer: 'Ответ', options: ['25', '30', '35', '40'] },
            { text: 'Решите задачу', answer: 'Ответ', options: ['10', '15', '20', '25'] }
        ],
        independent: [
            { text: 'Выполните вычисления по теме', answer: 'Проверьте по образцу' },
            { text: 'Решите примеры', answer: 'Проверьте по учебнику' },
            { text: 'Решите задачу', answer: 'Оценивается учителем' },
            { text: 'Выполните упражнения', answer: 'Проверьте' },
            { text: 'Найдите значения выражений', answer: 'Сверьте с ответами' }
        ],
        control: [
            { text: 'Выполните все задания по теме', answer: 'Оценивается учителем' },
            { text: 'Решите предложенные задачи', answer: 'Проверка учителем' },
            { text: 'Выполните контрольные задания', answer: 'Итоговая оценка' },
            { text: 'Решите все примеры', answer: 'Проверка' }
        ]
    };
    
    const russianTemplates = {
        test: [
            { text: 'Выполните задание по теме', answer: 'Проверьте', options: ['А', 'Б', 'В', 'Г'] },
            { text: 'Дайте правильный ответ', answer: 'Ответ', options: ['Вариант 1', 'Вариант 2', 'Вариант 3', 'Вариант 4'] },
            { text: 'Выберите верный вариант', answer: 'Ответ', options: ['А', 'Б', 'В', 'Г'] }
        ],
        independent: [
            { text: 'Выполните упражнение по теме', answer: 'Проверьте по учебнику' },
            { text: 'Спишите текст, выполнив задания', answer: 'Оценивается' },
            { text: 'Выполните задания к тексту', answer: 'Проверка' },
            { text: 'Напишите ответ на вопрос', answer: 'Оценивается' }
        ],
        control: [
            { text: 'Напишите работу по теме', answer: 'Итоговая оценка' },
            { text: 'Выполните все задания контрольной', answer: 'Оценивается' },
            { text: 'Напишите диктант', answer: 'Оценка за диктант' }
        ]
    };
    
    // Выбираем шаблоны в зависимости от предмета
    let templates;
    if (subject === 'Математика' || subject === 'Алгебра' || subject === 'Геометрия' || 
        subject === 'Физика' || subject === 'Химия') {
        templates = mathTemplates;
    } else {
        templates = russianTemplates;
    }
    
    const typeTemplates = templates[type] || templates['independent'];
    
    for (let i = 0; i < count; i++) {
        const template = typeTemplates[i % typeTemplates.length];
        
        if (type === 'test') {
            tasks.push({
                text: `${i + 1}. ${template.text} "${topic}"`,
                answer: template.answer,
                options: template.options
            });
        } else {
            tasks.push({
                text: `${i + 1}. ${template.text} "${topic}"`,
                answer: template.answer
            });
        }
    }
    
    // Перемешиваем результат
    return shuffleArray(tasks);
}

// DOM элементы
const classSelect = document.getElementById('classSelect');
const subjectSelect = document.getElementById('subjectSelect');
const lessonTopic = document.getElementById('lessonTopic');
const lessonName = document.getElementById('lessonName');
const workType = document.getElementById('workType');
const taskCount = document.getElementById('taskCount');
const variantCount = document.getElementById('variantCount');
const generatorForm = document.getElementById('generatorForm');
const outputSection = document.getElementById('outputSection');
const outputContent = document.getElementById('outputContent');
const editBtn = document.getElementById('editBtn');
const printBtn = document.getElementById('printBtn');
const newBtn = document.getElementById('newBtn');

let generatedAnswers = [];

// Обновление списка предметов при выборе класса
classSelect.addEventListener('change', function() {
    const classLevel = parseInt(this.value);
    const subjects = subjectsByClass[classLevel] || [];
    
    subjectSelect.innerHTML = '<option value="">Выберите предмет</option>';
    
    subjects.forEach(subject => {
        const option = document.createElement('option');
        option.value = subject;
        option.textContent = subject;
        subjectSelect.appendChild(option);
    });
    
    subjectSelect.disabled = false;
});

// Генерация заданий - поддержка нескольких вариантов
generatorForm.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const selectedClass = parseInt(classSelect.value);
    const subject = subjectSelect.value;
    const topic = lessonTopic.value;
    const name = lessonName.value;
    const type = workType.value;
    const count = parseInt(taskCount.value);
    const variants = parseInt(variantCount.value);
    
    let html = '';
    let allAnswers = [];
    
    // Генерируем каждый вариант отдельно
    for (let v = 1; v <= variants; v++) {
        const variantLetter = getVariantLetter(v);
        
        // Генерируем задания с учётом темы (каждый вариант уникальный)
        const tasks = generateTasks(subject, topic, selectedClass, type, count);
        
        // Генерируем HTML для одного варианта
        html += generateWorksheet(selectedClass, subject, topic, name, type, tasks, v, variantLetter);
        
        // Сохраняем ответы для этого варианта
        allAnswers.push({ variant: v, letter: variantLetter, answers: tasks.map(task => task.answer) });
    }
    
    outputContent.innerHTML = html;
    outputSection.style.display = 'block';
    
    // Сохраняем все ответы
    generatedAnswers = allAnswers;
    
    // Прокрутка к результату
    outputSection.scrollIntoView({ behavior: 'smooth' });
});

// Получение буквы варианта (А, Б, В, Г, Д...)
function getVariantLetter(num) {
    const letters = 'АБВГДЕЁЖЗИКЛМНОПРСТУФХЦЧШЩЭЮЯ';
    return letters[(num - 1) % letters.length];
}
// Генерация HTML для листа с заданиями
function generateWorksheet(classLevel, subject, topic, name, type, tasks, variantNum = 1, variantLetter = 'А') {
    const typeNames = {
        'test': 'Тест',
        'independent': 'Самостоятельная работа',
        'control': 'Контрольная работа'
    };
    
    let html = `
        <div class="worksheet">
            <div class="worksheet-header">
                <div class="worksheet-title">${typeNames[type]} - Вариант ${variantLetter}</div>
                <div class="worksheet-info"><strong>Предмет:</strong> ${subject}</div>
                <div class="worksheet-info"><strong>Класс:</strong> ${classLevel}</div>
                <div class="worksheet-info"><strong>Тема:</strong> ${topic}</div>
                <div class="worksheet-info"><strong>Урок:</strong> ${name}</div>
                <div class="worksheet-info"><strong>Дата:</strong> ${new Date().toLocaleDateString('ru-RU')}</div>
            </div>
            <ul class="task-list">
    `;
    
    // Нумеруем задания после перемешивания
    tasks.forEach((task, index) => {
        // Убираем старую нумерацию из текста задания (1., 2. и т.д.)
        const cleanText = task.text.replace(/^\d+\.\s*/, '');
        
        if (type === 'test') {
            let optionsHTML = '';
            if (task.options && task.options.length > 0) {
                task.options.forEach((option, optIndex) => {
                    optionsHTML += `
                        <div class="test-option">
                            <input type="radio" name="variant${variantLetter}_task${index}" id="variant${variantLetter}_task${index}_opt${optIndex}">
                            <label for="variant${variantLetter}_task${index}_opt${optIndex}">${option}</label>
                        </div>
                    `;
                });
            }
            
            html += `
                <li class="task-item">
                    <span class="task-text">${index + 1}. ${cleanText}</span>
                    ${task.textFull ? `<div class="task-text-full"><em>${task.textFull}</em></div>` : ''}
                    ${optionsHTML ? `<div class="test-options">${optionsHTML}</div>` : ''}
                </li>
            `;
        } else {
            html += `
                <li class="task-item">
                    <span class="task-text">${index + 1}. ${cleanText}</span>
                    ${task.textFull ? `<div class="task-text-full"><em>${task.textFull}</em></div>` : ''}
                </li>
            `;
        }
    });

    
    html += `
            </ul>
            <div class="answer-section">
                <h3>Ответы - Вариант ${variantLetter} (для учителя)</h3>
                <ul class="answer-list">
    `;
    
    tasks.forEach((task, index) => {
        html += `<li class="answer-item">${index + 1}. ${task.answer}</li>`;
    });
    
    html += `
                </ul>
            </div>
        </div>
    `;
    
    return html;
}


// Режим редактирования
let isEditing = false;

editBtn.addEventListener('click', function() {
    isEditing = !isEditing;
    outputContent.contentEditable = isEditing;
    editBtn.textContent = isEditing ? '💾 Сохранить' : '✏️ Редактировать';
    
    if (!isEditing) {
        outputContent.blur();
    } else {
        outputContent.focus();
    }
});

// Печать
printBtn.addEventListener('click', function() {
    window.print();
});

// Создать новую работу
newBtn.addEventListener('click', function() {
    outputSection.style.display = 'none';
    generatorForm.reset();
    subjectSelect.innerHTML = '<option value="">Сначала выберите класс</option>';
    subjectSelect.disabled = true;
    lessonTopic.value = '';
    lessonName.value = '';
    window.scrollTo({ top: 0, behavior: 'smooth' });
});
